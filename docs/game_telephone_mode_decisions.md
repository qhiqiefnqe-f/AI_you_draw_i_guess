# 你画我猜 · 接龙模式：方案决策复盘

本文档复盘接龙模式各功能的实现方案选择、优缺点与最终决策原因，作为长期参考与后续迭代依据。

## 指导原则
- 服务器权威状态机、全房同步推进，保证一致性与重连友好。
- 画板数据双轨（事件 + 图片），结果阶段逐帧重放、描述阶段用图片传递。
- MVP 以“无数据库 + 文件落盘快照”为核心，控制复杂度与成本。

## 阶段与状态推进（Prompt → Draw → Desc → Result）
- 方案 A：服务器权威推进（推荐）
  - 优点：一致性强、反作弊、断线重连友好；客户端简单。
  - 缺点：后端负载更高，需要良好节流与状态快照。
- 方案 B：客户端驱动/半权威
  - 优点：实现简单、服务端压力小。
  - 缺点：状态漂移、作弊与断线恢复困难。
- 最终选择：方案 A。
  - 原因：多人同步与阶段推进对一致性要求高，权威后端更稳。

## 奇数人数结尾策略（链尾必须是描述）
- 方案 A：每链参与 N-1 人（推荐）
  - 优点：所有链尾自然为描述；每阶段每人只处理一条链；节奏一致。
  - 缺点：每条链少一位参与者，需分配策略避免不公平（可轮转跳过）。
- 方案 B：发起者补一次描述作为尾步
  - 优点：链参与人数为 N，完整闭环。
  - 缺点：同一玩家在同链出现两次，节奏与公平性略受影响。
- 最终选择：方案 A（N-1）。
  - 原因：保证尾步为描述且各阶段负载均衡，分配更简单。

## 画板传输通道
- 方案 A：Socket.IO 广播（推荐）
  - 优点：稳定、易重连、服务端可做节流与背压；实现快速。
  - 缺点：服务器承担广播负载，随人数线性增长。
- 方案 B：WebRTC DataChannel
  - 优点：减轻服务器带宽。
  - 缺点：Mesh 在 6–10 人下复杂度与失败率高；重连与历史回放难；现有语音已是 Mesh，叠加风险。
- 最终选择：方案 A。
  - 原因：在预算与稳定性权衡下，Socket 更可靠、迭代成本低。

## 画板数据格式
- 方案 A：事件 + PNG/WebP（推荐）
  - 优点：逐帧重播；图片清晰用于下游描述；断线只需补事件与 URL。
  - 缺点：需要维护事件与图片两套存储。
- 方案 B：仅 PNG
  - 优点：实现最简单。
  - 缺点：展示阶段仅静态切图，缺少逐帧效果。
- 方案 C：事件 + WebP（优先，PNG 退化）
  - 优点：体积更小、带宽友好；浏览器兼容良好。
  - 缺点：少量浏览器/环境退化到 PNG。
- 最终选择：方案 C（事件 + WebP，失败回退 PNG）。
  - 原因：结合逐帧需求与带宽控制，WebP 优先更符合预算。

## 图片存储方式与预算（150 元/月）
- 方案 A：Socket 直接 Base64 传图
  - 优点：无需上传端点，开发快。
  - 缺点：消息体大（Base64 +33%）；内存与带宽占用高；重连与持久化不佳。
- 方案 B：HTTP 上传到后端本地磁盘（推荐）
  - 优点：Socket 只传 URL；稳定、可控；零外部成本；可配清理策略。
  - 缺点：需要磁盘与清理；水平扩展需共享存储。
- 方案 C：对象存储（OSS/COS/R2 等）
  - 优点：可靠持久化、CDN 加速、与应用服务器解耦。
  - 缺点：接入复杂；流量成本为主要开销。
  - 预算评估：以每局 ~10MB、月 50 局 → 存储 < 1 元；流量成本 0.2–1.0 元/GB，150 元/月足够中小规模。
- 最终选择：方案 B。
  - 原因：MVP 成本低、实现快、满足当前规模与保留期。

## 事件发送节流
- 方案：20/33/50ms。
- 最终选择：33ms。
  - 原因：在顺滑与带宽之间取得平衡；客户端与服务器更易处理。

## 保留期与清理
- 方案：7 天 / 30 天 / 展示后即清理。
- 最终选择：7 天。
  - 原因：兼顾用户回看与存储成本；定时清理简单。

## 展示播放方式
- 方案 A：逐帧重放（推荐）
  - 优点：更有现场感与幽默效果；与事件数据天然匹配。
  - 缺点：需要重放引擎与时间轴。
- 方案 B：静态切图
  - 优点：实现简单、稳定。
  - 缺点：表现力不足。
- 最终选择：方案 A。
  - 原因：玩法核心在“变形过程”，逐帧效果更契合。

## 观众模式
- 方案 A：进行中禁止加入（推荐）
  - 优点：避免干扰与同步复杂度；负载可控。
  - 缺点：观赛需求无法满足。
- 方案 B：只读观众模式
  - 优点：提升社交性。
  - 缺点：带来资源与同步负担。
- 最终选择：方案 A。
  - 原因：MVP 优先稳定与开发效率。

## 文本过滤
- 方案 A：取消过滤（当前选择）
  - 优点：实现简单、无额外延迟。
  - 缺点：存在内容风险；建议保留限频与长度限制。
- 方案 B：基础敏感词过滤
  - 优点：降低风险。
  - 缺点：需要词表与维护。
- 方案 C：严格过滤（近似词、词形处理）
  - 优点：更安全。
  - 缺点：复杂度与误杀风险高。
- 最终选择：方案 A。
  - 原因：MVP 快速推进；后续可按需要启用基础过滤。

## 缺席/断线策略
- 方案 A：允许继续（绘画自动快照、描述记为空白）（推荐）
  - 优点：全局节奏不受阻塞；体验稳定。
  - 缺点：链可能出现空白步。
- 方案 B：阻塞等待或跳过链
  - 优点：数据完整。
  - 缺点：整体节奏受影响，复杂度高。
- 最终选择：方案 A。
  - 原因：强调节奏与同步推进。

## 状态存储与持久化
- 方案 A：无数据库（文件 + 内存快照）（当前选择）
  - 优点：成本与复杂度低；实现速度快。
  - 缺点：进程重启丢失内存状态；水平扩展不便。
- 方案 B：数据库（SQLite/Postgres/Mongo 等）
  - 优点：可靠持久化、跨进程共享、利于统计与检索。
  - 缺点：引入运维与复杂度；初期成本提升。
- 最终选择：方案 A。
  - 原因：MVP 阶段满足需求；未来增长时平滑迁移到 DB。
- 迁移路径建议：
  - 短期：持续写 `rooms/<roomId>/state.json`；事件与图片落盘。
  - 中期：接入轻量 DB（SQLite → Postgres/Mongo）；存索引与元数据，图片仍本地或对象存储。

## 安全与体验（在“取消过滤”的前提下）
- 建议仍保留：文本长度限制、提交频率限制、基础异常防护（防止过大图片与事件刷写）。
- 结果阶段提供“举报/隐藏”入口（后续选项）。

## 已选定项总览
- 阶段推进：服务器权威。
- 奇数人数结尾：每链参与 N-1 人，尾步为描述。
- 传输通道：Socket.IO 广播。
- 数据格式：事件 + WebP（PNG 退化）。
- 图片存储：HTTP 上传至本地磁盘，静态服务访问。
- 事件节流：33ms。
- 保留期与清理：7 天。
- 展示播放：逐帧重放。
- 观众模式：进行中禁止加入。
- 文本过滤：取消（保留限频与长度限制的建议）。
- 缺席/断线：允许继续（自动快照/空白）。
- 持久化：无数据库（文件 + 内存快照），未来按需迁移。

—— 本文档用于长期参考，后续如有新的约束（规模增长、监管要求、分享需求等），可据此评估并调整到更适合的方案（对象存储、数据库、CDN、精细化过滤等）。